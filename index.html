<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bill Splitter</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", sans-serif;
        background: #f5f6f8;
        color: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 32px;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 24px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      }

      header h1 {
        margin: 0;
        font-size: 24px;
      }

      header p {
        margin: 6px 0 0;
        color: #6b7280;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(280px, 1fr) minmax(320px, 1.2fr) minmax(280px, 1fr);
        gap: 24px;
      }

      .card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .section-label {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
      }

      .field-grid {
        display: grid;
        gap: 12px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
      }

      .field-inline {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .field-inline select {
        min-width: 110px;
      }

      input,
      select {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        font-size: 14px;
      }

      .button-row {
        display: flex;
        gap: 10px;
      }

      .button {
        padding: 10px 14px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        background: #2563eb;
        color: white;
        cursor: pointer;
      }

      .button.secondary {
        background: #e5e7eb;
        color: #1f2937;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #f3f4f6;
        border-radius: 999px;
        font-size: 13px;
      }

      .people-list {
        display: grid;
        gap: 12px;
      }

      .person-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        display: grid;
        gap: 8px;
      }

      .person-card header {
        padding: 0;
        box-shadow: none;
        background: transparent;
        justify-content: space-between;
      }

      .items {
        display: grid;
        gap: 8px;
      }

      .item-row {
        display: grid;
        grid-template-columns: 1fr 90px auto;
        gap: 8px;
        align-items: center;
      }

      .summary-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
      }

      .ocr-controls {
        display: grid;
        gap: 12px;
      }

      .ocr-table {
        display: grid;
        gap: 8px;
      }

      .ocr-row {
        display: grid;
        grid-template-columns: 1.3fr 110px 110px 1fr;
        gap: 8px;
        align-items: center;
        padding: 8px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .ocr-row.low-confidence {
        border-color: #f59e0b;
        background: #fffbeb;
      }

      .ocr-row.discarded {
        opacity: 0.6;
        background: #f3f4f6;
      }

      .confidence-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 8px;
        border-radius: 999px;
        background: #e5e7eb;
        font-size: 12px;
        font-weight: 600;
      }

      .confidence-pill.low {
        background: #fef3c7;
        color: #92400e;
      }

      .ocr-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .ocr-actions .button {
        padding: 6px 10px;
        font-size: 12px;
      }

      .ocr-summary {
        display: grid;
        gap: 8px;
      }

      .summary-row strong {
        font-size: 16px;
      }

      .validation-panel {
        background: #111827;
        color: white;
        border-radius: 14px;
        padding: 16px;
        display: grid;
        gap: 12px;
      }

      .validation-panel .summary-row {
        color: #e5e7eb;
      }

      .person-breakdown {
        display: grid;
        gap: 6px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .person-breakdown:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .discrepancy {
        padding: 10px 12px;
        border-radius: 10px;
        background: #fef3c7;
        color: #92400e;
        font-weight: 600;
      }

      .discrepancy.warning {
        background: #fee2e2;
        color: #b91c1c;
      }

      .balance-note {
        font-size: 12px;
        color: #9ca3af;
        margin: 0;
      }

      .footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .button.venmo {
        background: #3d95ce;
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .helper-text {
        font-size: 12px;
        color: #6b7280;
        margin: 0;
      }

      .empty-state {
        padding: 16px;
        border-radius: 12px;
        border: 1px dashed #d1d5db;
        text-align: center;
        color: #6b7280;
        font-size: 14px;
      }

      @media (max-width: 1000px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div>
          <h1>Bill Splitter</h1>
          <p>Inline editing with immediate totals and reconciliation.</p>
        </div>
        <div class="pill">Last updated 2 minutes ago</div>
      </header>

      <div class="layout">
        <section class="card">
          <h2>Bill details</h2>
          <div class="field-grid">
            <div class="field">
              <label>Bill name</label>
              <input id="bill-name" type="text" placeholder="Dinner at La Mesa" />
            </div>
            <div class="field">
              <label>Tax</label>
              <div class="field-inline">
                <select id="bill-tax-mode">
                  <option value="amount">Amount</option>
                  <option value="percent">Percent</option>
                </select>
                <input id="bill-tax" type="text" placeholder="$0.00" />
              </div>
            </div>
            <div class="field">
              <label>Tip</label>
              <div class="field-inline">
                <select id="bill-tip-mode">
                  <option value="amount">Amount</option>
                  <option value="percent">Percent</option>
                </select>
                <input id="bill-tip" type="text" placeholder="$0.00" />
              </div>
            </div>
            <div class="field">
              <label>Additional fees</label>
              <input id="bill-fee" type="text" placeholder="$0.00" />
            </div>
            <div class="field">
              <label>Bill total (optional)</label>
              <input id="bill-actual-total" type="text" placeholder="$0.00" />
            </div>
            <div class="field">
              <label>Additional fee allocation</label>
              <select id="bill-fee-allocation">
                <option value="even">Even split</option>
                <option value="proportional">Proportional</option>
              </select>
            </div>
          </div>
          <div class="summary-row">
            <span class="section-label">Bill total</span>
            <strong id="bill-total">$0.00</strong>
          </div>
          <p class="helper-text">Totals update as you add items and fees.</p>
        </section>

        <section class="card">
          <div class="summary-row">
            <h2>People</h2>
          </div>
          <p class="section-label">Inline editing for names and item prices</p>
          <div class="people-list" id="people-list"></div>
          <div class="empty-state" id="people-empty">Add someone to start entering items.</div>
          <button class="button" id="add-person">+ Add person</button>
        </section>

        <section class="card">
          <div class="summary-row">
            <h2>OCR Import</h2>
            <div class="pill">Staging</div>
          </div>
          <p class="section-label">Review receipt OCR before adding to the bill</p>

          <div class="ocr-controls">
            <div class="field">
              <label>Upload or paste receipt image</label>
              <input id="ocr-image" type="file" accept="image/*" />
            </div>
            <div class="field">
              <label>Or paste image URL</label>
              <input id="ocr-image-url" type="text" placeholder="https://..." />
            </div>
            <div class="field-grid">
              <div class="field">
                <label>OCR Tax</label>
                <input id="ocr-tax" type="text" placeholder="$0.00" />
              </div>
              <div class="field">
                <label>OCR Tip</label>
                <input id="ocr-tip" type="text" placeholder="$0.00" />
              </div>
              <div class="field">
                <label>OCR Fees</label>
                <input id="ocr-fee" type="text" placeholder="$0.00" />
              </div>
              <div class="field">
                <label>OCR Total</label>
                <input id="ocr-total" type="text" placeholder="$0.00" />
              </div>
            </div>
          </div>

          <div class="ocr-table" id="ocr-list"></div>
          <div class="empty-state" id="ocr-empty">No OCR line items yet.</div>

          <div class="button-row">
            <button class="button secondary" id="ocr-merge-duplicates">Merge duplicates</button>
            <button class="button secondary" id="ocr-discard-all">Discard all</button>
            <button class="button" id="ocr-apply">Apply to bill</button>
          </div>

          <div class="ocr-summary">
            <div class="summary-row">
              <span class="section-label">OCR subtotal</span>
              <strong id="ocr-subtotal">$0.00</strong>
            </div>
            <div class="summary-row">
              <span class="section-label">OCR fees</span>
              <strong id="ocr-fee-total">$0.00</strong>
            </div>
            <div class="summary-row">
              <span class="section-label">OCR total estimate</span>
              <strong id="ocr-total-estimate">$0.00</strong>
            </div>
            <p class="helper-text">
              Inline edits update staging totals before committing to the bill.
            </p>
          </div>
        </section>

        <section class="card">
          <h2>Summary</h2>
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="summary-subtotal">$0.00</span>
          </div>
          <div class="summary-row">
            <span>Tax</span>
            <span id="summary-tax">$0.00</span>
          </div>
          <div class="summary-row">
            <span>Tip</span>
            <span id="summary-tip">$0.00</span>
          </div>
          <div class="summary-row">
            <span>Fees</span>
            <span id="summary-fee">$0.00</span>
          </div>
          <div class="summary-row">
            <strong>Total</strong>
            <strong id="summary-total">$0.00</strong>
          </div>

          <div class="validation-panel">
            <p class="balance-note">
              Track item subtotals here. Validation and reconciliation arrive in milestone 2.
            </p>
            <div id="person-summary"></div>
          </div>

          <div class="footer">
            <button class="button secondary">Save draft</button>
            <button class="button">Finalize split</button>
          </div>
        </section>
      </div>
    </div>
    <script>
      const currencyFormatter = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
      });

      const createId = (() => {
        let index = 0;
        return () => {
          index += 1;
          return `id-${index}`;
        };
      })();

      const state = {
        bill: {
          name: "",
          tax: "",
          taxMode: "amount",
          tip: "",
          tipMode: "amount",
          fee: "",
          feeAllocation: "even",
          actualTotal: "",
        },
        ocr: {
          imageUrl: "",
          service: "ocrSpace",
          feedback: {
            state: "idle",
            message: "No OCR line items yet.",
          },
          summary: {
            tax: "",
            tip: "",
            fee: "",
            total: "",
          },
          totals: {
            subtotal: 0,
            tax: "",
            tip: "",
            fee: "",
            total: "",
          },
          items: [],
        },
        people: [],
      };

      const elements = {
        billName: document.querySelector("#bill-name"),
        billTax: document.querySelector("#bill-tax"),
        billTaxMode: document.querySelector("#bill-tax-mode"),
        billTip: document.querySelector("#bill-tip"),
        billTipMode: document.querySelector("#bill-tip-mode"),
        billFee: document.querySelector("#bill-fee"),
        billActualTotal: document.querySelector("#bill-actual-total"),
        billFeeAllocation: document.querySelector("#bill-fee-allocation"),
        billTotal: document.querySelector("#bill-total"),
        addPerson: document.querySelector("#add-person"),
        peopleList: document.querySelector("#people-list"),
        peopleEmpty: document.querySelector("#people-empty"),
        summarySubtotal: document.querySelector("#summary-subtotal"),
        summaryTax: document.querySelector("#summary-tax"),
        summaryTip: document.querySelector("#summary-tip"),
        summaryFee: document.querySelector("#summary-fee"),
        summaryTotal: document.querySelector("#summary-total"),
        personSummary: document.querySelector("#person-summary"),
        ocrImage: document.querySelector("#ocr-image"),
        ocrImageUrl: document.querySelector("#ocr-image-url"),
        ocrTax: document.querySelector("#ocr-tax"),
        ocrTip: document.querySelector("#ocr-tip"),
        ocrFee: document.querySelector("#ocr-fee"),
        ocrTotal: document.querySelector("#ocr-total"),
        ocrList: document.querySelector("#ocr-list"),
        ocrEmpty: document.querySelector("#ocr-empty"),
        ocrSubtotal: document.querySelector("#ocr-subtotal"),
        ocrFeeTotal: document.querySelector("#ocr-fee-total"),
        ocrTotalEstimate: document.querySelector("#ocr-total-estimate"),
        ocrApply: document.querySelector("#ocr-apply"),
        ocrMergeDuplicates: document.querySelector("#ocr-merge-duplicates"),
        ocrDiscardAll: document.querySelector("#ocr-discard-all"),
      };

      const parseCurrency = (value) => {
        if (!value) return 0;
        const numeric = Number.parseFloat(value.replace(/[^0-9.-]/g, ""));
        return Number.isNaN(numeric) ? 0 : numeric;
      };

      const formatCurrency = (value) => currencyFormatter.format(value);

      const parsePercent = (value) => {
        if (!value) return 0;
        const numeric = Number.parseFloat(value.replace(/[^0-9.-]/g, ""));
        return Number.isNaN(numeric) ? 0 : numeric / 100;
      };

      const getPersonSubtotal = (person) =>
        person.items.reduce((total, item) => total + parseCurrency(item.price), 0);

      const getItemsSubtotal = () =>
        state.people.reduce((total, person) => total + getPersonSubtotal(person), 0);

      const getOcrSubtotal = () =>
        state.ocr.items
          .filter((item) => item.status !== "discarded")
          .reduce((total, item) => total + parseCurrency(item.price), 0);

      const getOcrTotalEstimate = () => {
        const subtotal = getOcrSubtotal();
        const tax = parseCurrency(state.ocr.summary.tax);
        const tip = parseCurrency(state.ocr.summary.tip);
        const fee = parseCurrency(state.ocr.summary.fee);
        const totalOverride = parseCurrency(state.ocr.summary.total);
        const computed = subtotal + tax + tip + fee;
        return totalOverride || computed;
      };

      const getAllocationRatio = (person) => {
        const subtotal = getPersonSubtotal(person);
        const totalSubtotal = getItemsSubtotal();
        if (!totalSubtotal) return 0;
        return subtotal / totalSubtotal;
      };

      const getFeeAllocationRatio = (person) => {
        if (state.bill.feeAllocation === "even") {
          return state.people.length ? 1 / state.people.length : 0;
        }
        return getAllocationRatio(person);
      };

      const getPersonTotals = (person) => {
        const subtotal = getPersonSubtotal(person);
        const ratio = getAllocationRatio(person);
        const feeRatio = getFeeAllocationRatio(person);
        const tax = getBillTaxAmount();
        const tip = getBillTipAmount();
        const fee = parseCurrency(state.bill.fee);
        const taxShare = tax * ratio;
        const tipShare = tip * ratio;
        const feeShare = fee * feeRatio;
        const total = subtotal + taxShare + tipShare + feeShare;
        return { subtotal, taxShare, tipShare, feeShare, total };
      };

      const getBillTaxAmount = () => {
        if (state.bill.taxMode === "percent") {
          return getItemsSubtotal() * parsePercent(state.bill.tax);
        }
        return parseCurrency(state.bill.tax);
      };

      const getBillTipAmount = () => {
        if (state.bill.tipMode === "percent") {
          return getItemsSubtotal() * parsePercent(state.bill.tip);
        }
        return parseCurrency(state.bill.tip);
      };

      const renderSummary = () => {
        const subtotal = getItemsSubtotal();
        const tax = getBillTaxAmount();
        const tip = getBillTipAmount();
        const fee = parseCurrency(state.bill.fee);
        const total = subtotal + tax + tip + fee;

        elements.summarySubtotal.textContent = formatCurrency(subtotal);
        elements.summaryTax.textContent = formatCurrency(tax);
        elements.summaryTip.textContent = formatCurrency(tip);
        elements.summaryFee.textContent = formatCurrency(fee);
        elements.summaryTotal.textContent = formatCurrency(total);
        elements.billTotal.textContent = formatCurrency(total);
      };

      const renderOcrSummary = () => {
        const subtotal = getOcrSubtotal();
        const estimate = getOcrTotalEstimate();
        elements.ocrSubtotal.textContent = formatCurrency(subtotal);
        elements.ocrFeeTotal.textContent = formatCurrency(parseCurrency(state.ocr.summary.fee));
        elements.ocrTotalEstimate.textContent = formatCurrency(estimate);
      };

      const renderPersonSummary = () => {
        elements.personSummary.innerHTML = "";
        if (!state.people.length) {
          elements.personSummary.innerHTML =
            '<p class="balance-note">No people yet. Add someone to see their subtotal.</p>';
          return;
        }
        state.people.forEach((person) => {
          const totals = getPersonTotals(person);
          const name = person.name || "Untitled";
          const note = state.bill.name.trim() || "Bill split";
          const venmoParams = new URLSearchParams({
            txn: "charge",
            amount: totals.total.toFixed(2),
            note,
          });
          const venmoLink = `venmo://paycharge?${venmoParams.toString()}`;
          const block = document.createElement("div");
          block.className = "person-breakdown";
          block.innerHTML = `
            <div class="summary-row">
              <strong>${name}</strong>
              <div class="button-row">
                <strong>${formatCurrency(totals.total)}</strong>
                <a class="button venmo" href="${venmoLink}" target="_blank" rel="noopener">
                  Request on Venmo
                </a>
              </div>
            </div>
            <div class="summary-row">
              <span>Subtotal</span>
              <span>${formatCurrency(totals.subtotal)}</span>
            </div>
            <div class="summary-row">
              <span>Tax share</span>
              <span>${formatCurrency(totals.taxShare)}</span>
            </div>
            <div class="summary-row">
              <span>Tip share</span>
              <span>${formatCurrency(totals.tipShare)}</span>
            </div>
            <div class="summary-row">
              <span>Fee share</span>
              <span>${formatCurrency(totals.feeShare)}</span>
            </div>
          `;
          elements.personSummary.appendChild(block);
        });
      };

      const renderPeople = () => {
        elements.peopleList.innerHTML = "";
        state.people.forEach((person) => {
          const card = document.createElement("div");
          card.className = "person-card";
          card.dataset.person = person.id;

          const header = document.createElement("header");
          const totals = getPersonTotals(person);
          header.innerHTML = `
            <strong>${person.name || "Untitled person"}</strong>
            <span class="pill">${formatCurrency(totals.subtotal)}</span>
          `;

          const items = document.createElement("div");
          items.className = "items";

          person.items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "item-row";
            row.innerHTML = `
              <input type="text" value="${item.name}" placeholder="Item name" data-person="${person.id}" data-item="${item.id}" data-field="name" />
              <input type="text" value="${item.price}" placeholder="$0.00" data-person="${person.id}" data-item="${item.id}" data-field="price" />
              <button class="button secondary" data-person="${person.id}" data-item="${item.id}" data-action="remove-item">Remove</button>
            `;
            items.appendChild(row);
          });

          const addItemButton = document.createElement("button");
          addItemButton.className = "button";
          addItemButton.textContent = "+ Add item";
          addItemButton.dataset.person = person.id;
          addItemButton.dataset.action = "add-item";
          items.appendChild(addItemButton);

          const nameField = document.createElement("div");
          nameField.className = "field";
          nameField.innerHTML = `
            <label>Person name</label>
            <input type="text" value="${person.name}" data-person="${person.id}" data-field="person-name" />
          `;

          const removeButton = document.createElement("button");
          removeButton.className = "button secondary";
          removeButton.textContent = "Remove person";
          removeButton.dataset.person = person.id;
          removeButton.dataset.action = "remove-person";

          card.appendChild(header);
          card.appendChild(nameField);
          card.appendChild(items);
          card.appendChild(removeButton);
          elements.peopleList.appendChild(card);
        });

        elements.peopleEmpty.style.display = state.people.length ? "none" : "block";
      };

      const renderOcrItems = () => {
        elements.ocrList.innerHTML = "";
        state.ocr.items.forEach((item) => {
          const row = document.createElement("div");
          const isLowConfidence = item.confidence < 0.75;
          row.className = `ocr-row${isLowConfidence ? " low-confidence" : ""}${
            item.status === "discarded" ? " discarded" : ""
          }`;
          row.dataset.item = item.id;
          const confidencePercent = Math.round(item.confidence * 100);
          const confidenceClass = isLowConfidence ? "confidence-pill low" : "confidence-pill";
          const approveLabel = item.status === "approved" ? "Approved" : "Approve";
          const discardLabel = item.status === "discarded" ? "Discarded" : "Discard";
          row.innerHTML = `
            <input type="text" value="${item.name}" placeholder="Item name" data-item="${item.id}" data-field="name" />
            <input type="text" value="${item.price}" placeholder="$0.00" data-item="${item.id}" data-field="price" />
            <span class="${confidenceClass}">${confidencePercent}% conf.</span>
            <div class="ocr-actions">
              <button class="button secondary" data-item="${item.id}" data-action="approve">${approveLabel}</button>
              <button class="button secondary" data-item="${item.id}" data-action="discard">${discardLabel}</button>
              <button class="button secondary" data-item="${item.id}" data-action="reset">Reset</button>
            </div>
          `;
          elements.ocrList.appendChild(row);
        });
        const isEmpty = !state.ocr.items.length;
        elements.ocrEmpty.style.display = isEmpty ? "block" : "none";
        if (isEmpty) {
          elements.ocrEmpty.textContent = state.ocr.feedback.message || "No OCR line items yet.";
        }
      };

      const render = () => {
        renderPeople();
        renderSummary();
        renderPersonSummary();
        renderOcrItems();
        renderOcrSummary();
      };

      const updateBillField = (field, value) => {
        state.bill[field] = value;
        renderSummary();
        renderPersonSummary();
      };

      const updatePersonCard = (personId) => {
        const card = elements.peopleList.querySelector(
          `.person-card[data-person="${personId}"]`
        );
        if (!card) return;
        const person = state.people.find((entry) => entry.id === personId);
        if (!person) return;
        const headerName = card.querySelector("header strong");
        const headerPill = card.querySelector("header .pill");
        if (headerName) {
          headerName.textContent = person.name || "Untitled person";
        }
        if (headerPill) {
          headerPill.textContent = formatCurrency(getPersonTotals(person).subtotal);
        }
      };

      const formatCurrencyInput = (input) => {
        const value = parseCurrency(input.value);
        input.value = value ? formatCurrency(value) : "";
      };

      const formatPercentInput = (input) => {
        const numeric = Number.parseFloat(input.value.replace(/[^0-9.-]/g, ""));
        input.value = Number.isNaN(numeric) ? "" : `${numeric}%`;
      };

      const updatePersonName = (personId, value) => {
        const person = state.people.find((entry) => entry.id === personId);
        if (person) {
          person.name = value;
          updatePersonCard(personId);
          renderPersonSummary();
        }
      };

      const updateItemField = (personId, itemId, field, value) => {
        const person = state.people.find((entry) => entry.id === personId);
        if (!person) return;
        const item = person.items.find((entry) => entry.id === itemId);
        if (!item) return;
        item[field] = value;
        updatePersonCard(personId);
        renderSummary();
        renderPersonSummary();
      };

      const updateOcrItemField = (itemId, field, value) => {
        const item = state.ocr.items.find((entry) => entry.id === itemId);
        if (!item) return;
        item[field] = value;
        renderOcrSummary();
      };

      const setOcrItemStatus = (itemId, status) => {
        const item = state.ocr.items.find((entry) => entry.id === itemId);
        if (!item) return;
        item.status = status;
        renderOcrItems();
        renderOcrSummary();
      };

      const mergeDuplicateOcrItems = () => {
        const merged = new Map();
        state.ocr.items.forEach((item) => {
          const key = item.name.trim().toLowerCase();
          if (!key) {
            merged.set(item.id, { ...item });
            return;
          }
          const existing = merged.get(key);
          if (!existing) {
            merged.set(key, { ...item });
            return;
          }
          existing.price = formatCurrency(parseCurrency(existing.price) + parseCurrency(item.price));
          existing.confidence = Math.max(existing.confidence, item.confidence);
          if (item.status === "approved") {
            existing.status = "approved";
          }
        });
        state.ocr.items = Array.from(merged.values()).map((item) => ({
          ...item,
          price: item.price ? formatCurrency(parseCurrency(item.price)) : "",
        }));
        renderOcrItems();
        renderOcrSummary();
      };

      const discardAllOcrItems = () => {
        state.ocr.items = state.ocr.items.map((item) => ({
          ...item,
          status: "discarded",
        }));
        renderOcrItems();
        renderOcrSummary();
      };

      const OCR_SERVICES = {
        ocrSpace: {
          id: "ocrSpace",
          label: "OCR.Space",
          async request({ file, url }) {
            const endpoint = "https://api.ocr.space/parse/image";
            const formData = new FormData();
            formData.append("apikey", "helloworld");
            formData.append("language", "eng");
            formData.append("isOverlayRequired", "true");
            if (file) {
              formData.append("file", file);
            } else if (url) {
              formData.append("url", url);
            }
            const response = await fetch(endpoint, {
              method: "POST",
              body: formData,
            });
            if (!response.ok) {
              throw new Error("OCR request failed. Please try again.");
            }
            return response.json();
          },
          parse(payload) {
            if (!payload || payload.IsErroredOnProcessing) {
              const message = payload?.ErrorMessage?.join(", ") || "OCR failed to read the receipt.";
              throw new Error(message);
            }
            const parsed = payload.ParsedResults?.[0];
            const lines = parsed?.TextOverlay?.Lines || [];
            return lines.map((line) => {
              const words = line.Words || [];
              const confidences = words.map((word) => Number(word.Confidence || 0));
              const averageConfidence = confidences.length
                ? confidences.reduce((sum, value) => sum + value, 0) / confidences.length / 100
                : 0.7;
              return {
                text: line.LineText || "",
                confidence: averageConfidence,
              };
            });
          },
        },
      };

      const setOcrFeedback = ({ state: status, message }) => {
        state.ocr.feedback = { state: status, message };
        renderOcrItems();
      };

      const normalizeLineText = (text) => text.replace(/\s+/g, " ").trim();

      const extractOcrTotals = (lines) => {
        const totals = {
          subtotal: 0,
          tax: "",
          tip: "",
          fee: "",
          total: "",
        };
        lines.forEach(({ text }) => {
          const cleaned = normalizeLineText(text).toLowerCase();
          const value = parseCurrency(cleaned);
          if (!value) return;
          if (cleaned.includes("subtotal")) {
            totals.subtotal = value;
            return;
          }
          if (cleaned.includes("tax")) {
            totals.tax = formatCurrency(value);
            return;
          }
          if (cleaned.includes("tip") || cleaned.includes("gratuity")) {
            totals.tip = formatCurrency(value);
            return;
          }
          if (cleaned.includes("fee") || cleaned.includes("service")) {
            totals.fee = formatCurrency(value);
            return;
          }
          if (cleaned.includes("total")) {
            totals.total = formatCurrency(value);
          }
        });
        return totals;
      };

      const isLikelySummaryLine = (text) =>
        ["subtotal", "tax", "tip", "gratuity", "fee", "service", "total"].some((keyword) =>
          text.includes(keyword)
        );

      const parseOcrLineItems = (lines) =>
        lines
          .map((line) => ({ ...line, normalized: normalizeLineText(line.text) }))
          .filter((line) => line.normalized)
          .filter((line) => !isLikelySummaryLine(line.normalized.toLowerCase()))
          .map((line) => {
            const match = line.normalized.match(/(.+?)\s+(-?\$?\d+(?:\.\d{2})?)/);
            if (!match) return null;
            const name = match[1].trim();
            const priceValue = parseCurrency(match[2]);
            if (!name || !priceValue) return null;
            return {
              id: createId(),
              name,
              price: formatCurrency(priceValue),
              confidence: Number.isFinite(line.confidence) ? line.confidence : 0.7,
              status: "pending",
            };
          })
          .filter(Boolean);

      const applyOcrTotalsToSummary = (totals) => {
        state.ocr.totals = {
          subtotal: totals.subtotal || 0,
          tax: totals.tax || "",
          tip: totals.tip || "",
          fee: totals.fee || "",
          total: totals.total || "",
        };
        state.ocr.summary.tax = totals.tax || "";
        state.ocr.summary.tip = totals.tip || "";
        state.ocr.summary.fee = totals.fee || "";
        state.ocr.summary.total = totals.total || "";
        elements.ocrTax.value = state.ocr.summary.tax;
        elements.ocrTip.value = state.ocr.summary.tip;
        elements.ocrFee.value = state.ocr.summary.fee;
        elements.ocrTotal.value = state.ocr.summary.total;
      };

      const runOcrImport = async ({ file, url }) => {
        if (!file && !url) {
          setOcrFeedback({
            state: "error",
            message: "Select a receipt image or paste a URL to start OCR.",
          });
          return;
        }
        const service = OCR_SERVICES[state.ocr.service] || OCR_SERVICES.ocrSpace;
        setOcrFeedback({ state: "loading", message: "Running OCR on your receipt..." });
        state.ocr.items = [];
        renderOcrItems();
        try {
          const payload = await service.request({ file, url });
          const lines = service.parse(payload);
          const totals = extractOcrTotals(lines);
          const items = parseOcrLineItems(lines);
          state.ocr.items = items;
          applyOcrTotalsToSummary(totals);
          if (!items.length) {
            setOcrFeedback({
              state: "empty",
              message: "No line items detected. Adjust the image or try again.",
            });
          } else {
            setOcrFeedback({ state: "ready", message: "" });
          }
          renderOcrItems();
          renderOcrSummary();
        } catch (error) {
          const message =
            error instanceof Error
              ? error.message
              : "OCR failed. Please try a different image.";
          setOcrFeedback({ state: "error", message });
          state.ocr.items = [];
          applyOcrTotalsToSummary({
            subtotal: 0,
            tax: "",
            tip: "",
            fee: "",
            total: "",
          });
          renderOcrSummary();
        }
      };

      const getOrCreateUnassignedPerson = () => {
        let person = state.people.find((entry) => entry.name === "Unassigned");
        if (!person) {
          person = { id: createId(), name: "Unassigned", items: [] };
          state.people.push(person);
        }
        return person;
      };

      const applyOcrToBill = () => {
        const approvedItems = state.ocr.items.filter((item) => item.status === "approved");
        if (approvedItems.length) {
          const unassigned = getOrCreateUnassignedPerson();
          approvedItems.forEach((item) => {
            unassigned.items.push({
              id: createId(),
              name: item.name,
              price: item.price ? formatCurrency(parseCurrency(item.price)) : "",
            });
          });
        }

        if (state.ocr.summary.tax) {
          state.bill.tax = state.ocr.summary.tax;
          elements.billTax.value = state.ocr.summary.tax;
        }
        if (state.ocr.summary.tip) {
          state.bill.tip = state.ocr.summary.tip;
          elements.billTip.value = state.ocr.summary.tip;
        }
        if (state.ocr.summary.fee) {
          state.bill.fee = state.ocr.summary.fee;
          elements.billFee.value = state.ocr.summary.fee;
        }
        if (state.ocr.summary.total) {
          state.bill.actualTotal = state.ocr.summary.total;
          elements.billActualTotal.value = state.ocr.summary.total;
        }

        state.ocr.items = state.ocr.items.filter((item) => item.status !== "approved");
        render();
      };

      const addPerson = () => {
        state.people.push({
          id: createId(),
          name: "",
          items: [
            { id: createId(), name: "", price: "" },
            { id: createId(), name: "", price: "" },
          ],
        });
        render();
      };

      const removePerson = (personId) => {
        state.people = state.people.filter((person) => person.id !== personId);
        render();
      };

      const addItem = (personId) => {
        const person = state.people.find((entry) => entry.id === personId);
        if (!person) return;
        person.items.push({ id: createId(), name: "", price: "" });
        render();
      };

      const removeItem = (personId, itemId) => {
        const person = state.people.find((entry) => entry.id === personId);
        if (!person) return;
        person.items = person.items.filter((item) => item.id !== itemId);
        render();
      };

      elements.addPerson.addEventListener("click", addPerson);

      elements.peopleList.addEventListener("input", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        const personId = target.dataset.person;
        const itemId = target.dataset.item;
        const field = target.dataset.field;
        if (field === "person-name" && personId) {
          updatePersonName(personId, target.value);
        }
        if (personId && itemId && field) {
          updateItemField(personId, itemId, field, target.value);
        }
      });

      elements.peopleList.addEventListener("blur", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (target.dataset.field === "price") {
          formatCurrencyInput(target);
        }
      }, true);

      elements.peopleList.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const action = target.dataset.action;
        const personId = target.dataset.person;
        const itemId = target.dataset.item;
        if (!action || !personId) return;
        if (action === "add-item") {
          addItem(personId);
        }
        if (action === "remove-item" && itemId) {
          removeItem(personId, itemId);
        }
        if (action === "remove-person") {
          removePerson(personId);
        }
      });

      elements.ocrList.addEventListener("input", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        const itemId = target.dataset.item;
        const field = target.dataset.field;
        if (itemId && field) {
          updateOcrItemField(itemId, field, target.value);
        }
      });

      elements.ocrList.addEventListener("blur", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (target.dataset.field === "price") {
          formatCurrencyInput(target);
          const itemId = target.dataset.item;
          if (itemId) {
            updateOcrItemField(itemId, "price", target.value);
          }
        }
      }, true);

      elements.ocrList.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const action = target.dataset.action;
        const itemId = target.dataset.item;
        if (!action || !itemId) return;
        if (action === "approve") {
          setOcrItemStatus(itemId, "approved");
        }
        if (action === "discard") {
          setOcrItemStatus(itemId, "discarded");
        }
        if (action === "reset") {
          setOcrItemStatus(itemId, "pending");
        }
      });

      elements.billName.addEventListener("input", (event) => {
        updateBillField("name", event.target.value);
      });
      elements.billTax.addEventListener("input", (event) => {
        updateBillField("tax", event.target.value);
      });
      elements.billTip.addEventListener("input", (event) => {
        updateBillField("tip", event.target.value);
      });
      elements.billFee.addEventListener("input", (event) => {
        updateBillField("fee", event.target.value);
      });
      elements.billActualTotal.addEventListener("input", (event) => {
        updateBillField("actualTotal", event.target.value);
      });

      elements.ocrImageUrl.addEventListener("input", (event) => {
        state.ocr.imageUrl = event.target.value;
      });
      elements.ocrImageUrl.addEventListener("keydown", (event) => {
        if (event.key !== "Enter") return;
        event.preventDefault();
        const url = event.target.value.trim();
        runOcrImport({ url });
      });
      elements.ocrImageUrl.addEventListener("change", (event) => {
        const url = event.target.value.trim();
        if (url) {
          runOcrImport({ url });
        }
      });
      elements.ocrImage.addEventListener("change", (event) => {
        const file = event.target.files?.[0];
        if (file) {
          runOcrImport({ file });
        }
      });
      elements.ocrTax.addEventListener("input", (event) => {
        state.ocr.summary.tax = event.target.value;
        renderOcrSummary();
      });
      elements.ocrTip.addEventListener("input", (event) => {
        state.ocr.summary.tip = event.target.value;
        renderOcrSummary();
      });
      elements.ocrFee.addEventListener("input", (event) => {
        state.ocr.summary.fee = event.target.value;
        renderOcrSummary();
      });
      elements.ocrTotal.addEventListener("input", (event) => {
        state.ocr.summary.total = event.target.value;
        renderOcrSummary();
      });

      elements.ocrTax.addEventListener("blur", (event) => {
        formatCurrencyInput(event.target);
        state.ocr.summary.tax = event.target.value;
        renderOcrSummary();
      });
      elements.ocrTip.addEventListener("blur", (event) => {
        formatCurrencyInput(event.target);
        state.ocr.summary.tip = event.target.value;
        renderOcrSummary();
      });
      elements.ocrFee.addEventListener("blur", (event) => {
        formatCurrencyInput(event.target);
        state.ocr.summary.fee = event.target.value;
        renderOcrSummary();
      });
      elements.ocrTotal.addEventListener("blur", (event) => {
        formatCurrencyInput(event.target);
        state.ocr.summary.total = event.target.value;
        renderOcrSummary();
      });

      elements.billTax.addEventListener("blur", (event) => {
        if (state.bill.taxMode === "percent") {
          formatPercentInput(event.target);
          return;
        }
        formatCurrencyInput(event.target);
      });
      elements.billTip.addEventListener("blur", (event) => {
        if (state.bill.tipMode === "percent") {
          formatPercentInput(event.target);
          return;
        }
        formatCurrencyInput(event.target);
      });
      elements.billFee.addEventListener("blur", (event) => {
        formatCurrencyInput(event.target);
      });
      elements.billActualTotal.addEventListener("blur", (event) => {
        formatCurrencyInput(event.target);
      });
      elements.billFeeAllocation.addEventListener("change", (event) => {
        updateBillField("feeAllocation", event.target.value);
      });
      elements.billTaxMode.addEventListener("change", (event) => {
        updateBillField("taxMode", event.target.value);
      });
      elements.billTipMode.addEventListener("change", (event) => {
        updateBillField("tipMode", event.target.value);
      });

      elements.ocrMergeDuplicates.addEventListener("click", mergeDuplicateOcrItems);
      elements.ocrDiscardAll.addEventListener("click", discardAllOcrItems);
      elements.ocrApply.addEventListener("click", applyOcrToBill);

      addPerson();
      addPerson();
    </script>
  </body>
</html>
